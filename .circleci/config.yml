# Golang CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-go/ for more details
version: 2.1

jobs:
  build:
    docker:
      - image: circleci/golang:1.13.5
    working_directory: /go/src/github.com/HewlettPackard/hpecli    
    steps:
      - run:
        name: Install SonarScanner
        command: |
          export SONAR_SCANNER_VERSION=4.2.0.1873
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
          rm -rf $SONAR_SCANNER_HOME
          mkdir -p $SONAR_SCANNER_HOME
          curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
          unzip $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          rm $HOME/.sonar/sonar-scanner.zip
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          export SONAR_SCANNER_OPTS="-server"                                    
      - checkout
      - run: mkdir -p coverage/go/coverage.out
      - run: go get -v -t -d ./...
      - run: go test ./... -short -coverprofile=coverage/go/coverage.out
      - run: ./build.sh
      - run: |
          sonar-scanner \
            -Dsonar.projectKey=HewlettPackard_hpecli \
            -Dsonar.organization=hewlettpackard \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=1625ff6e233cd521f29d008e995bbbe432c4b0bf